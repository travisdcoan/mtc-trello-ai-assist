<!-- docs/done-popup.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      font-family: sans-serif;
      padding: 12px;
    }
    h3 {
      margin-top: 0;
    }
    label {
      display: block;
      margin: 12px 0;
      font-size: 14px;
    }
    label input {
      margin-right: 8px;
    }
    select, button {
      width: 100%;
      margin: 8px 0;
      padding: 8px;
      font-size: 14px;
      cursor: pointer;
    }
    #cancel-btn {
      background: none;
      border: none;
      color: #555;
      text-decoration: underline;
      font-size: 13px;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <h3>Done Workflow</h3>

  <label>
    <input type="checkbox" id="move-checkbox" />
    Move card to DONE list
  </label>

  <label>
    Next steps:
    <select id="next-steps">
      <option>suggestion one</option>
      <option>suggestion two</option>
    </select>
  </label>

  <button id="confirm-btn">Confirm</button>
  <button id="cancel-btn">Cancel</button>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    const APP_KEY = "2d28f67731b868888a2fc22bdd3295af";

    // Initialize the Power-Up iframe client
    const t = window.TrelloPowerUp.iframe({
      appKey:    APP_KEY,
      appName:   "Verb-Starter Checker",
      appAuthor: "Trav Coan"
    });

    t.render(async () => {
      try {
        // Retrieve passed-in arguments
        const cardId  = t.arg('cardId');
        const boardId = t.arg('boardId');
        const moveCb  = document.getElementById('move-checkbox');
        const stepsEl = document.getElementById('next-steps');
        const confirm = document.getElementById('confirm-btn');
        const cancel  = document.getElementById('cancel-btn');

        // Ensure we have authorization to call Trello's REST API
        const client = t.getRestApi();
        if (!(await client.isAuthorized())) {
          await client.authorize({
            scope:          { read: true, write: true },
            expiration:     'never',
            callbackMethod: 'postMessage'
          });
        }
        const token = await client.getToken();

        confirm.addEventListener('click', async () => {
          // 1) Move card if checkbox is checked
          if (moveCb.checked) {
            // Fetch all lists on the board
            const lists = await fetch(
              `https://api.trello.com/1/boards/${boardId}/lists?key=${APP_KEY}&token=${token}`
            ).then(res => res.json());

            // Find the list named exactly "done" (case-insensitive)
            const doneList = lists.find(l => l.name.toLowerCase() === 'done');
            if (doneList) {
              await fetch(
                `https://api.trello.com/1/cards/${cardId}?key=${APP_KEY}&token=${token}`,
                {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ idList: doneList.id })
                }
              );
            } else {
              t.notification({
                message: `Couldnâ€™t find a list named "done".`,
                duration: 5
              });
            }
          }

          // 2) Handle next-steps selection (placeholder logic)
          console.log('Next step chosen:', stepsEl.value);

          // 3) Close the popup
          t.closePopup();
        });

        cancel.addEventListener('click', () => {
          t.closePopup();
        });

      } catch (err) {
        console.error("Error in done-popup:", err);
        document.body.innerHTML = `<p style="color:red">An error occurred: ${err.message}</p>`;
      }
    });
  </script>
</body>
</html>
