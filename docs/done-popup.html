<!-- https://becurrent.mixtapeco.com/trello-powerup/done-popup.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Done Options</title>
  <style>
    :root { color-scheme: light dark; }
    body {
      margin: 0; padding: 0 14px 14px 14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: #172B4D; background: #F7F8F9;
    }
    h1 { font-size: 16px; margin: 0 0 8px; font-weight: 700; }
    .row { margin: 10px 0; }
    .small { color:#6B778C; font-size: 12px; }
    .panel {
      background:#fff; border:1px solid #DFE1E6; border-radius:8px; padding:12px;
    }
    label { display:block; margin-bottom:6px; }
    select, input[type="checkbox"] { font: inherit; }
    .btnrow { display:flex; gap:8px; margin-top:12px; }
    button {
      appearance:none; border:0; border-radius:6px; padding:8px 12px;
      font-weight:600; cursor:pointer;
    }
    .primary { background:#0C66E4; color:#fff; }
    .secondary { background:#091e4214; color:#172B4D; }
    .error {
      color:#AE2A19; background:#FFEBE6; border:1px solid #FFD2CC;
      padding:10px; border-radius:6px; font-size: 13px; margin-top:8px;
    }
    .success {
      color:#164B35; background:#DFFCF0; border:1px solid #BAF3DB;
      padding:10px; border-radius:6px; font-size:13px; margin-top:8px;
    }
    .muted { color:#44546F; }
  </style>
</head>
<body>
  <h1>Finish this card?</h1>
  <div class="panel">
    <div class="row">
      <label><input type="checkbox" id="moveToDone" checked>
        Move to <strong id="doneName">(detecting…)</strong>
      </label>
      <div class="small" id="doneHint">Prefers the list you chose in Settings.</div>
    </div>

    <div class="row" id="fallbackRow" style="display:none">
      <label for="listPicker">No saved “Done” list found. Pick a list to move to:</label>
      <select id="listPicker"></select>
      <div class="small muted">This won’t change the saved setting — it just moves this card.</div>
    </div>

    <div class="row">
      <label for="nextStep">Next step (optional)</label>
      <select id="nextStep">
        <option value="">— choose —</option>
        <option>suggestion one</option>
        <option>suggestion two</option>
        <option>suggestion three</option>
      </select>
    </div>

    <div id="msg"></div>

    <div class="btnrow">
      <button id="confirm" class="primary">Apply</button>
      <button id="cancel" class="secondary">Cancel</button>
    </div>
  </div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script src="./config.js"></script>
  <script>
    const { APP_KEY, APP_NAME, APP_AUTHOR } = window.BC;

    const t = window.TrelloPowerUp.iframe({
      appKey:    APP_KEY,
      appName:   APP_NAME,
      appAuthor: APP_AUTHOR
    });

    // helper: close popup + card
    function closeAll() {
      try { t.hideCard(); } catch (_) {}
      try { t.closePopup(); } catch (_) {}
    }

    function ui(id) { return document.getElementById(id); }
    function showError(text) {
      ui('msg').innerHTML = `<div class="error">${text}</div>`;
    }
    function showSuccess(text) {
      ui('msg').innerHTML = `<div class="success">${text}</div>`;
    }

    async function ensureWriteAuth(client){
      if (!(await client.isAuthorized())) {
        await client.authorize({
          scope: 'read,write',
          expiration: 'never',
          callbackMethod: 'postMessage',
          name: 'BeCurrent'
        });
      }
      const token = await client.getToken();
      if (!token) throw new Error('No Trello token after authorize.');
      return token;
    }


    async function fetchJSON(url) {
      const res = await fetch(url);
      const txt = await res.text();
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}: ${txt.slice(0,200)}`);
      try { return JSON.parse(txt); }
      catch { throw new Error("Non-JSON response: " + txt.slice(0,200)); }
    }

    function pickDoneCandidate(lists){
      const EXACT = /^(done|complete|completed)$/i;
      const CONTAINS = /(done|complete)/i;
      let exact = lists.find(l => EXACT.test(l.name || ''));
      if (exact) return exact;
      return lists.find(l => CONTAINS.test(l.name || '')) || null;
    }

    t.render(async () => {
      try {
        const cardId        = t.arg("cardId");
        const passedBoardId = t.arg("boardId"); // may be provided by opener
        const client        = t.getRestApi();

        if (!cardId) throw new Error("Missing cardId in args.");

        // Get lists via Power-Up client (no REST auth)
        const allLists = await t.lists("all");
        const openLists = allLists.filter(l => !l.closed);

        // 1) Prefer saved setting
        let saved = await t.get("board", "shared", "doneList"); // { id, name } or undefined
        let doneId   = saved?.id || null;
        let doneName = saved?.name || null;

        // 2) If no saved, try auto-detect by name
        if (!doneId) {
          const guess = pickDoneCandidate(openLists);
          if (guess) {
            doneId   = guess.id;
            doneName = guess.name;
          }
        }

        // Update UI (same as before, but use openLists instead of `lists` from REST)
        if (doneId && doneName) {
          ui("doneName").textContent = `“${doneName}”`;
          ui("fallbackRow").style.display = "none";
        } else {
          ui("doneName").textContent = "(not set)";
          ui("fallbackRow").style.display = "block";
          ui("moveToDone").checked = false;

          const sel = ui("listPicker");
          sel.innerHTML = "";
          for (const l of openLists) {
            const opt = document.createElement("option");
            opt.value = l.id;
            opt.textContent = l.name;
            sel.appendChild(opt);
          }
        }
        // Actions
        ui("confirm").addEventListener("click", async () => {
          ui("msg").innerHTML = "";
          try {
            let destListId = null;

            if (ui("moveToDone").checked) {
              if (doneId) {
                destListId = doneId;
              } else {
                destListId = ui("listPicker").value || null;
              }
            }

            // If there's nowhere to move and no other behaviour, just close.
            if (!destListId) {
              showSuccess("No changes applied.");
              setTimeout(() => closeAll(), 800);
              return;
            }

            const client = t.getRestApi();
            let token = await ensureUserToken(client);

            if (!token) {
              showError(
                'We need permission from Trello before we can move cards. ' +
                'Click Apply again and choose “Allow” in the Trello window.'
              );
              return;
            }

            const res = await fetch(
              `https://api.trello.com/1/cards/${cardId}?key=${encodeURIComponent(
                APP_KEY
              )}&token=${encodeURIComponent(token)}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ idList: destListId }),
              }
            );

            if (res.status === 401) {
              try { await client.clearToken(); } catch (_) {}
              showError(
                "Your Trello access seems to have expired. Click Apply again to re-authorize."
              );
              return;
            }

            if (!res.ok) {
              const txt = await res.text().catch(() => "");
              throw new Error(`${res.status} ${res.statusText}: ${txt.slice(0, 200)}`);
            }

            const next = ui("nextStep").value;
            if (next) {
              showSuccess(`Done — moved card • Next: ${next}`);
            } else {
              showSuccess("Done — moved card.");
            }

            setTimeout(() => closeAll(), 800);
          } catch (err) {
            console.error("[DonePopup] apply error:", err);
            showError("Could not apply changes. " + (err.message || err));
          }
        });


        ui('cancel').addEventListener('click', () => closeAll());

      } catch (err) {
        console.error("[DonePopup] render error:", err);
        showError(err.message || "Unexpected error.");
      }
    });
  </script>
</body>
</html>
